#!/bin/bash

cd $(dirname $0)

vars_file=$(mktemp)
out_file=$(mktemp)

find configs -name '*.m4' | grep -v 'inc\.m4$' | while read file; do
	echo -n > $vars_file
	m4 -DVARS_FILE=$vars_file -Iconfigs header.m4 $file footer.m4 > $out_file || continue
	source $vars_file || continue
	eval full_file_name=$file_name || continue
	backup_file_name=backup_configs$full_file_name
	
	if [ -f "$full_file_name" ]; then
		if [ -f "$backup_file_name" ]; then
			if ! diff -c "$backup_file_name" "$full_file_name"; then
				echo "WARNING: $file_name config changed since last run. Not updating."
				continue;
			fi
		else
			echo "WARNING: $file_name not generated by this script. Not updating."
			continue;
		fi
	fi
	
	mkdir -p $(dirname $backup_file_name) $(dirname $full_file_name)
	cp $out_file $full_file_name
	cp $out_file $backup_file_name
done

rm $vars_file $out_file
